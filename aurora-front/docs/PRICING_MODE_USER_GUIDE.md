# 定价模式使用指南

## 什么是定价模式？

定价模式（Pricing Mode）决定了回测系统如何计算交易价格。不同的定价模式可以模拟不同级别的市场真实度。

## 两种定价模式

### 1. 收盘价模式 (Close Mode)

**特点：**
- 最简单的模式
- 买入和卖出都使用 K 线的收盘价
- 计算速度快
- 真实度较低

**适用场景：**
- 快速验证策略逻辑
- 初步测试阶段
- 对精度要求不高的场景

**配置示例：**
```toml
[backtest.pricing_mode]
mode = "close"
```

### 2. 买一卖一价模式 (Bid-Ask Mode)

**特点：**
- 更真实的模式
- 买入时使用卖一价（ask price）
- 卖出时使用买一价（bid price）
- 需要设置买卖价差（spread）
- 真实度更高

**适用场景：**
- 正式的策略评估
- 需要精确回测结果
- 生产环境前的最终测试

**配置示例：**
```toml
[backtest.pricing_mode]
mode = "bid_ask"
spread_pct = 0.001  # 0.1% 价差
```

## 买卖价差（Spread）说明

### 什么是价差？

价差是买一价和卖一价之间的差值，以百分比表示。

### 如何设置合适的价差？

| 币种类型 | 建议价差 | 说明 |
|---------|---------|------|
| 主流币（BTC、ETH） | 0.01% - 0.05% | 流动性好，价差小 |
| 中等市值币 | 0.05% - 0.2% | 流动性一般 |
| 小市值币 | 0.2% - 1% | 流动性差，价差大 |

### 价差计算示例

假设 BTC 价格为 $50,000，价差为 0.1%（0.001）：

- 中间价：$50,000
- 价差金额：$50,000 × 0.001 = $50
- 卖一价（ask）：$50,025（买入时的价格）
- 买一价（bid）：$49,975（卖出时的价格）

## 在前端如何配置

### 步骤 1: 启用回测配置

1. 访问配置管理页面（`/config`）
2. 找到"回测配置"区域
3. 如果未启用，点击"+ 启用回测配置"按钮

### 步骤 2: 配置定价模式

1. 向下滚动到"定价模式配置"区域
2. 点击"定价模式"下拉菜单
3. 选择以下选项之一：
   - **默认(不设置)**: 不指定定价模式，使用系统默认行为
   - **收盘价模式**: 使用 K 线收盘价
   - **买一卖一价模式**: 使用买一卖一价

### 步骤 3: 设置价差（仅买一卖一价模式）

如果选择了"买一卖一价模式"：

1. 在"买卖价差百分比"输入框中输入数值
2. 输入范围：0 到 1
3. 常用值示例：
   - `0.0001` = 0.01%（极低价差，适合高频交易）
   - `0.001` = 0.1%（推荐值，适合大多数主流币）
   - `0.002` = 0.2%（中等价差）
   - `0.01` = 1%（较大价差，适合小币种）

### 步骤 4: 保存配置

1. 点击页面底部的"保存配置"按钮
2. 系统会验证配置的有效性
3. 保存成功后，配置会以 TOML 格式存储

## 常见问题

### Q1: 什么时候应该使用买一卖一价模式？

**A:** 当你需要：
- 评估策略的真实盈利能力
- 考虑交易成本对收益的影响
- 进行最终的策略验证

### Q2: 价差设置得太大或太小会怎样？

**A:** 
- **太小**：回测结果可能过于乐观，与实盘有较大偏差
- **太大**：回测结果可能过于保守，可能错过好策略
- **建议**：参考实际市场数据设置合理的价差

### Q3: 不设置定价模式会怎样？

**A:** 系统会使用默认行为，通常是收盘价模式。

### Q4: 可以在回测过程中修改定价模式吗？

**A:** 不建议。定价模式应该在回测开始前确定，修改后需要重新运行回测。

## 最佳实践

1. **初期测试**: 使用收盘价模式快速验证策略逻辑
2. **精细调优**: 使用买一卖一价模式进行精确评估
3. **参数设置**: 根据实际市场数据设置合理的价差
4. **对比分析**: 同时运行两种模式，对比结果差异
5. **文档记录**: 记录使用的定价模式和参数，便于后续分析

## 示例配置

### 示例 1: 快速测试配置

```toml
[backtest]
data_path = "btc_1h.csv"
symbol = "BTCUSDT"
interval = "1h"

[backtest.pricing_mode]
mode = "close"
```

### 示例 2: 精确回测配置

```toml
[backtest]
data_path = "btc_1h.csv"
symbol = "BTCUSDT"
interval = "1h"

[backtest.pricing_mode]
mode = "bid_ask"
spread_pct = 0.001
```

### 示例 3: 小币种配置

```toml
[backtest]
data_path = "alt_1h.csv"
symbol = "ALTUSDT"
interval = "1h"

[backtest.pricing_mode]
mode = "bid_ask"
spread_pct = 0.005  # 0.5% 价差，适合小币种
```

## 技术支持

如有问题，请参考：
- [技术实现文档](./PRICING_MODE_IMPLEMENTATION.md)
- [配置示例代码](./PRICING_MODE_EXAMPLES.ts)
- [项目 GitHub Issues](https://github.com/blingbling21/aurora/issues)

---

**最后更新**: 2025-11-06  
**版本**: 1.0.0
