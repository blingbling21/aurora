# 回测执行页面问题修复总结

## 修复日期
2025-11-13

## 问题概述

### 问题 1: WebSocket 连接错误
**现象**: 第二次及以后点击"开始回测"按钮时出现 WebSocket 连接错误提示

**原因**: 
- 第一次任务完成后,`currentTaskId` 状态未清理
- 新任务启动时,旧的 taskId 仍然触发 WebSocket 连接
- 导致尝试连接到已完成的任务,引发错误

**解决方案**:
```typescript
// 在 handleStartBacktest 函数开始时:
setCurrentTaskId(null);  // 清理旧的 taskId
setIsTaskCompleted(false);  // 重置完成状态
setProgress(0);  // 重置进度
await new Promise(resolve => setTimeout(resolve, 100));  // 等待 WebSocket 断开
```

### 问题 2: 进度显示固定跳转
**现象**: 进度永远是 50% → 90% → 100%,无论数据量大小

**原因**:
- 后端硬编码进度值:10% → 30% → 50% → 90% → 100%
- 未基于实际数据处理进度推送

**解决方案**:
1. 加载数据获取总条数
2. 基于数据量估算处理时间
3. 启动异步任务平滑推送 15% 到 85% 之间的进度
4. 回测完成后取消进度任务

## 修改的文件

### 前端
1. `aurora-front/src/app/backtest/page.tsx`
   - 修改 `handleStartBacktest` 函数
   - 添加状态清理逻辑
   - 添加延迟等待

### 后端
1. `aurora-web/src/api/backtest.rs`
   - 添加真实进度回调机制
   - 移除了之前的进度估算代码
   - 实现基于K线处理数量的真实进度

2. `aurora-backtester/src/engine.rs`
   - 添加 `run_with_progress` 方法支持进度回调
   - 添加 `run_backtest_with_progress` 公共函数
   - 在处理每根K线时计算并回调进度

## 新的进度阶段

| 进度 | 阶段 | 说明 |
|------|------|------|
| 0% | 初始化 | 任务创建 |
| 5% | 配置加载中 | 正在加载配置文件 |
| 10% | 参数提取 | 策略参数提取完成 |
| 15% | 准备回测 | 配置完成,准备开始回测 |
| 15%-95% | 回测执行 | **基于实际处理的K线数量实时推送** |
| 95% | 结果生成 | 回测完成,生成结果中 |
| 100% | 任务完成 | 全部完成 |

**重点**: 15%-95% 之间是真实进度,由回测引擎根据实际处理的K线数实时回调推送。

## 测试验证

### 前端测试
创建了 `page-fix.test.tsx` 验证:
- ✅ WebSocket 在 taskId 变化时正确断开/重连
- ✅ taskId 为 null 时不自动连接
- ✅ 任务完成时不重连
- ✅ 进度值在有效范围内 (0-100)
- ✅ 进度阶段递增

### 后端编译
- ✅ aurora-web 编译成功,无错误
- ✅ 服务启动正常

## 技术亮点

1. **状态清理机制**: 确保每次启动新任务前状态干净
2. **真实进度推送**: 基于实际处理的K线数量计算进度,而非估算
3. **进度回调设计**: 回测引擎支持可选的进度回调函数
4. **异步进度更新**: 不阻塞回测执行,提供流畅体验
5. **与数据下载一致**: 采用与数据下载页面相同的进度推送模式

## 文档
- `docs/BACKTEST_WEBSOCKET_FIX.md` - 详细修复说明

## 遵循项目约定
- ✅ 添加了详细注释
- ✅ 遵循 Apache 2.0 许可证
- ✅ 类型安全 (TypeScript/Rust)
- ✅ 错误处理完善
- ✅ 创建了测试文件
