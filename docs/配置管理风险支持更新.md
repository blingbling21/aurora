# Aurora Config 风险管理配置支持更新总结

## 更新日期
2025年10月14日

## 更新概述

为配合 `aurora-portfolio` 新增的风险管理功能,对 `aurora-config` 进行了扩展,使其能够通过配置文件管理风险规则和仓位策略。

## 更新内容

### 1. 扩展配置类型 (`types.rs`)

#### 新增 `RiskRulesConfig` 结构体
对应 `aurora-portfolio::RiskRules`,支持以下风险控制配置:

```rust
pub struct RiskRulesConfig {
    pub max_drawdown_pct: Option<f64>,           // 最大回撤限制
    pub max_daily_loss_pct: Option<f64>,         // 单日最大亏损限制
    pub max_consecutive_losses: Option<u32>,      // 连续亏损次数限制
    pub max_single_trade_loss_pct: Option<f64>,  // 单笔交易最大亏损
    pub min_equity: Option<f64>,                  // 最低权益要求
    pub stop_loss_pct: Option<f64>,              // 止损百分比
    pub take_profit_pct: Option<f64>,            // 止盈百分比
}
```

**功能**:
- ✅ 配置验证 (`validate()`)
- ✅ 类型转换 (`to_risk_rules()` - 需启用 `portfolio-integration` feature)

#### 新增 `PositionSizingConfig` 枚举
对应 `aurora-portfolio::PositionSizingStrategy`,支持多种仓位策略:

```rust
pub enum PositionSizingConfig {
    FixedAmount { amount: f64 },
    FixedPercentage { percentage: f64 },
    KellyCriterion {
        win_rate: f64,
        profit_loss_ratio: f64,
        kelly_fraction: f64,
    },
    Pyramid {
        initial_percentage: f64,
        profit_threshold: f64,
        max_percentage: f64,
        increment: f64,
    },
    AllIn,
}
```

**功能**:
- ✅ 配置验证 (`validate()`)
- ✅ 类型转换 (`to_position_sizing_strategy()` - 需启用 `portfolio-integration` feature)

#### 扩展 `PortfolioConfig` 结构体

添加了两个可选字段:
```rust
pub struct PortfolioConfig {
    // ... 现有字段 ...
    pub risk_rules: Option<RiskRulesConfig>,
    pub position_sizing: Option<PositionSizingConfig>,
}
```

### 2. 更新依赖配置 (`Cargo.toml`)

添加可选的 portfolio 集成:
```toml
[dependencies]
aurora-portfolio = { path = "../aurora-portfolio", optional = true }

[features]
portfolio-integration = ["aurora-portfolio"]
```

这允许使用方选择是否需要类型转换功能。

### 3. 更新配置示例文件

#### `backtest_config.toml`
添加了完整的风险管理配置示例:
```toml
[portfolio.risk_rules]
max_drawdown_pct = 15.0
max_daily_loss_pct = 5.0
max_consecutive_losses = 3
min_equity = 5000.0
stop_loss_pct = 2.0
take_profit_pct = 5.0

[portfolio.position_sizing]
strategy_type = "fixed_percentage"
percentage = 0.2
```

#### `complete_config.toml`
添加了详细注释的所有仓位策略示例:
- 固定金额策略
- 固定比例策略
- Kelly准则策略
- 金字塔加仓策略
- 全仓策略

### 4. 测试覆盖

新增 9 个单元测试:
- ✅ `test_risk_rules_config` - 风险规则配置加载
- ✅ `test_risk_rules_validation_valid` - 有效配置验证
- ✅ `test_risk_rules_validation_invalid_drawdown` - 无效配置验证
- ✅ `test_position_sizing_fixed_percentage` - 固定比例策略
- ✅ `test_position_sizing_kelly` - Kelly准则策略
- ✅ `test_position_sizing_pyramid` - 金字塔策略
- ✅ `test_position_sizing_validation_valid` - 有效策略验证
- ✅ `test_position_sizing_validation_invalid` - 无效策略验证
- ✅ `test_portfolio_with_risk_and_position` - 完整配置测试

**测试通过率: 100% (47 个单元测试 + 8 个集成测试)**

### 5. 文档更新

- ✅ 更新 `lib.rs` 文档,添加风险管理和仓位管理说明
- ✅ 导出新类型: `RiskRulesConfig`, `PositionSizingConfig`
- ✅ 配置示例文件中添加详细注释

## 配置示例

### 基础风险管理配置
```toml
[portfolio]
initial_cash = 10000.0

[portfolio.risk_rules]
max_drawdown_pct = 15.0
stop_loss_pct = 2.0
take_profit_pct = 5.0

[portfolio.position_sizing]
strategy_type = "fixed_percentage"
percentage = 0.2
```

### 高级Kelly准则配置
```toml
[portfolio.position_sizing]
strategy_type = "kelly_criterion"
win_rate = 0.6
profit_loss_ratio = 2.0
kelly_fraction = 0.5
```

### 金字塔加仓配置
```toml
[portfolio.position_sizing]
strategy_type = "pyramid"
initial_percentage = 0.1
profit_threshold = 5.0
max_percentage = 0.5
increment = 0.1
```

## 类型转换使用

### 启用 portfolio-integration feature

在使用 `aurora-config` 的 crate 的 `Cargo.toml` 中:
```toml
[dependencies]
aurora-config = { path = "../aurora-config", features = ["portfolio-integration"] }
aurora-portfolio = { path = "../aurora-portfolio" }
```

### 使用转换函数

```rust
use aurora_config::Config;

// 加载配置
let config = Config::from_file("backtest_config.toml")?;

// 转换为 portfolio 类型
if let Some(risk_config) = &config.portfolio.risk_rules {
    let risk_rules = risk_config.to_risk_rules();
    let risk_manager = RiskManager::new(risk_rules, config.portfolio.initial_cash);
}

if let Some(position_config) = &config.portfolio.position_sizing {
    let strategy = position_config.to_position_sizing_strategy();
    let position_manager = PositionManager::new(strategy);
}
```

## 配置验证

所有新配置都包含验证逻辑:

```rust
// 验证风险规则
if let Some(risk_rules) = &config.portfolio.risk_rules {
    risk_rules.validate()?;
}

// 验证仓位策略
if let Some(position_sizing) = &config.portfolio.position_sizing {
    position_sizing.validate()?;
}
```

## 向后兼容性

- ✅ 所有新字段都是 `Option<T>` 类型,保持向后兼容
- ✅ 现有配置文件无需修改即可继续使用
- ✅ 新功能通过可选 feature 启用,不影响不需要的使用方

## 后续工作

虽然配置支持已完成,但在 `aurora-backtester` 和 `aurora-live` 中使用这些配置还需要:

1. **启用 portfolio-integration feature**
2. **在回测/实时引擎中集成 RiskManager 和 PositionManager**
3. **根据配置创建并使用风险管理组件**

这些工作可以在后续迭代中完成。

## 文件变更清单

### 修改的文件
- `aurora-config/src/types.rs` - 新增风险和仓位配置类型
- `aurora-config/src/lib.rs` - 更新文档和导出
- `aurora-config/src/types/tests.rs` - 新增测试
- `aurora-config/Cargo.toml` - 添加可选依赖
- `examples/backtest_config.toml` - 添加风险管理示例
- `examples/complete_config.toml` - 添加完整配置示例

### 测试结果
- 单元测试: 47/47 通过 ✅
- 集成测试: 8/8 通过 ✅
- 文档测试: 2/2 通过 ✅
- **总通过率: 100%**

## 总结

成功为 `aurora-config` 添加了完整的风险管理和仓位管理配置支持,使用户能够通过 TOML 配置文件灵活地配置各种风控策略和仓位管理方式。

所有新功能都保持向后兼容,并通过可选 feature 提供类型转换,使得配置系统既灵活又易用。

---

**实现者**: GitHub Copilot  
**审核**: 待审核  
**状态**: 完成 ✅
